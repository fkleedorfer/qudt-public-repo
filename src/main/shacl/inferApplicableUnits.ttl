@prefix rdf: 	<http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: 	<http://www.w3.org/2000/01/rdf-schema#> .
@prefix sh: 	<http://www.w3.org/ns/shacl#> .
@prefix xsd: 	<http://www.w3.org/2001/XMLSchema#> .
@prefix skos: <http://www.w3.org/2004/02/skos/core#> .
@prefix sq: <http://qudt.org/2.1/shacl/infer/applicableUnits> .
@prefix qudt: <http://qudt.org/schema/qudt/> .
@prefix qk: <http://qudt.org/schema/quantitykind/> .

qudt:
    sh:declare [
                   sh:prefix "qudt" ;
                   sh:namespace "http://qudt.org/schema/qudt/"^^xsd:anyURI 
               ] .

skos:
    sh:declare [
                   sh:prefix "skos" ;
                   sh:namespace "http://www.w3.org/2004/02/skos/core#"^^xsd:anyURI 
               ] .
qk: 
    sh:declare [
                    sh:prefix "qk";
                    sh:namespace "http://qudt.org/schema/quantitykind/"^^xsd:anyURI
               ] .
rdfs:
    sh:declare [
               sh:prefix "rdfs";
               sh:namespace  "http://www.w3.org/2000/01/rdf-schema#" ;
               ] .

sq:qkRule
    a sh:NodeShape;
    sh:targetClass qudt:QuantityKind;
    sh:rule [
        a sh:SPARQLRule ;
        sh:prefixes qudt:;
        sh:prefixes skos:;
        sh:prefixes qk:;
        sh:prefixes rdfs:;
        sh:construct """
        CONSTRUCT {
            $this qudt:applicableUnit ?unit .
            $this rdfs:comment ?comment .
        } WHERE {
            SELECT
                 $this
                 ?qk
                 ?unit
                 (CONCAT("Applicable units are those of ",
                   REPLACE(STR(?qk),"http://qudt.org/vocab/quantitykind/","quantitykind:")) as ?comment)
            WHERE {
                {
                    SELECT
                        $this
                        ?qk
                        ?steps
                    WHERE {
                        {
                            SELECT
                                $this
                                ?qk
                                (COUNT(*) as ?steps)
                            WHERE {
                                $this skos:broader+ ?mid .
                                ?mid skos:broader* ?qk .
                            }
                            GROUP BY $this ?qk
                        }
                        FILTER EXISTS {
                            ?unit qudt:hasQuantityKind ?qk
                        }
                    }
                    ORDER BY ASC(?steps)
                    LIMIT 1
                }
                ?unit qudt:hasQuantityKind ?qk
            }
        }
        """
    ] .
